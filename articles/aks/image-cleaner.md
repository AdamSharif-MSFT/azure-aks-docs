---
title: Use ImageCleaner on Azure Kubernetes Service (AKS)
description: Learn how to use ImageCleaner to clean up stale images on Azure Kubernetes Service (AKS)
ms.author: nickoman
author: nickomang
services: container-service
ms.topic: article
ms.date: 08/26/2022
---

# Use ImageCleaner to clean up stale images on your Azure Kubernetes Service cluster (preview)

It's common to use pipelines to build and deploy images on Azure Kubernetes Service (AKS) clusters. While great for image creation, this process often doesn't account for the stale images left behind and can lead to image bloat on cluster nodes. These images can present security issues as they may contain vulnerabilities. By cleaning these unreferenced images, you can remove an area of risk in your clusters. When done manually, this process can be time intensive, which ImageCleaner can mitigate via automatic image identification and removal.

[!INCLUDE [preview features callout](./includes/preview/preview-callout.md)]

## Prerequisites

* An Azure subscription. If you don't have an Azure subscription, you can create a [free account](https://azure.microsoft.com/free).
* [Azure CLI][azure-cli-install] or [Azure PowerShell][azure-powershell-install] and the `aks-preview` CLI extension installed.
* The `ImageCleanerPreview` feature flag registered on your subscription:

### [Azure CLI](#tab/azure-cli)

Register the `ImageCleanerPreview` feature flag by using the [az feature register][az-feature-register] command, as shown in the following example:

```azurecli-interactive
az feature register --namespace "Microsoft.ContainerService" --name "ImageCleanerPreview"
```

It takes a few minutes for the status to show *Registered*. Verify the registration status by using the [az feature list][az-feature-list] command:

```azurecli-interactive
az feature list -o table --query "[?contains(name, 'Microsoft.ContainerService/ImageCleanerPreview')].{Name:name,State:properties.state}"
```

When ready, refresh the registration of the *Microsoft.ContainerService* resource provider by using the [az provider register][az-provider-register] command:

```azurecli-interactive
az provider register --namespace Microsoft.ContainerService
```

### [Azure PowerShell](#tab/azure-powershell)

Register the `ImageCleanerPreview` feature flag by using the [Register-AzProviderPreviewFeature][register-azproviderpreviewfeature] cmdlet, as shown in the following example:

```azurepowershell-interactive
Register-AzProviderPreviewFeature -ProviderNamespace Microsoft.ContainerService -Name ImageCleanerPreview
```

It takes a few minutes for the status to show *Registered*. Verify the registration status by using the [Get-AzProviderPreviewFeature][get-azproviderpreviewfeature] cmdlet:

```azurepowershell-interactive
Get-AzProviderPreviewFeature -ProviderNamespace Microsoft.ContainerService -Name ImageCleanerPreview |
 Format-Table -Property Name, @{name='State'; expression={$_.Properties.State}}
```

When ready, refresh the registration of the *Microsoft.ContainerService* resource provider by using the [Register-AzResourceProvider][register-azresourceprovider] command:

```azurepowershell-interactive
Register-AzResourceProvider -ProviderNamespace Microsoft.ContainerService
```

---

## How ImageCleaner works

When enabled, an agent is deployed on each agent node, which will use an `ImageList` CRD to determine unreferenced and vulnerable images. An `ImageList` can either be defined manually or automatically generated by ImageCleaner.

In manual mode, the `ImageList` is created based off of a provided list of image names. In automatic mode, a time interval is set. ImageCleaner will continually run in this interval to generate an updated `ImageList`.

Once an `ImageList` is generated, ImageCleaner will delete all the images in the list from node VMs.

## Configuration options

In addition to choosing between manual and automatic mode, there are several options for ImageCleaner:

|Name|Description|Required|
|----|-----------|--------|
|--enable-image-cleaner|Enable the ImageCleaner feature for an AKS cluster|Yes, unless disable is specified|
|--disable-image-cleaner|Disable the ImageCleaner feature for an AKS cluster|Yes, unless enable is specified|
|--image-cleaner-interval-hours|This parameter determines the interval time (in hours) ImageCleaner will use to run. The default value is one week, the minimum value is 24 hours and the maximum is three months.|No|

## Enable ImageCleaner on your AKS cluster

#### Enable ImageCleaner on your cluster

To create a new AKS cluster using the default interval:

```azurecli-interactive
az aks create -g MyResourceGroup -n MyManagedCluster \ 
  --enable-image-cleaner 
```

To enable on an existing AKS cluster:

```azurecli-interactive
az aks update -g MyResourceGroup -n MyManagedCluster \ 
  --enable-image-cleaner 
```

The `--image-cleaner-interval-hours` parameter can be specified at creation time or for an existing cluster. For example, the following command updates the interval for a cluster with ImageCleaner already enabled:

```azurecli-interactive
az aks update -g MyResourceGroup -n MyManagedCluster \
  --image-cleaner-interval-hours 48
```

Based on your configuration, ImageCleaner will automatically generate an `ImageList` containing unreferenced/vulnerable images at the set interval. ImageCleaner will automatically remove these images from cluster nodes.

## Disable ImageCleaner

To stop using ImageCleaner, you can disable it via the `--disable-image-cleaner` flag:

```azurecli-interactive
az aks update -g MyResourceGroup -n MyManagedCluster
  -- disable-image-cleaner
```

## Logging

The deletion logs are stored in the `image-cleaner-kind-worker` pods. You can check these via `kubectl logs` or via the Container Insights pod log table if the [Azure Monitor add-on](,/monitor-aks.md) is enabled.