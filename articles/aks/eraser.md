---
title: Use Eraser on Azure Kubernetes Service (AKS)
description: Learn how to use Eraser to clean up stale images on on Azure Kubernetes Service (AKS)
ms.author: nickoman
author: nickomang
services: container-service
ms.topic: article
ms.date: 08/26/2022
---

# Use Eraser to clean up stale images on your Azure Kubernetes Service cluster (preview)

It's common to use DevOps pipelines to build and deploy images on Azure Kubernetes Service (AKS) clusters. While great for image creation, this process often does not account for the stale images left behind and can lead to image bloat on the nodes. These images can present security issues as they may contain vulnerabilities. By cleaning these unreferenced images, you can remove an area of risk in your clusters. When done manually, this can be time intensive process-  something Eraser can mitigate via automatic image identification and removal.

[!INCLUDE [preview features callout](./includes/preview/preview-callout.md)]

## Prerequisites

## How Eraser works

When enabled, an `eraser-controller-manager` is deployed on each agent node. This manager will use an `ImageList` CRD to determine unreferenced and vulnerable images. An `ImageList` can either be defined manually or automatically generated by Eraser.

In manual mode, the `ImageList` is created based off of a provided list of image names. In automatic mode, a time interval is set. Eraser will continually run in this interval to generate an updated `ImageList`.

Once an `ImageList` is generated, Eraser will delete all the images in the list from node VMs.

## Configuration options

In addition to choosing between manual and automatic mode, there are several options for Eraser:

|Name|Description|Required|
|----|-----------|--------|
|--enable-eraser|Enable the eraser feature for an AKS cluster|Yes, unless disable is specified|
|--disable-eraser|Disable the eraser feature for an AKS cluster|Yes, unless enable is specified|
|--eraser-vulnerability-scan|With enabled, Eraser will scan/delete both unused and vulnerable images. Without it, Eraser only scans/deletes unused images.|Yes|
|--eraser-interval|With this parameter, the mode is set to automatic. Without it, the mode is manual. This determines the interval time Eraser will use to run. The default value is one week, the Minimum value is 24 hours, and the maximum is 3 months.|No|
|--eraser-vulnerability-severity|The severity levels to be considered while scanning vulnerable images. Available options are: `low`, `medium`, `high`, and `critical`. The default value is `high`, meaning both images with severity level tag `high` and `critical` are recognized as vulnerabilities to be removed.|Yes|
|--eraser-allowlist|Used to prevent specific images from deletion. The default value is null.|No| 

## Enable Eraser on your AKS cluster

### Manual mode

#### Enable Eraser on your cluster

To enable Eraser on a new AKS cluster using manual mode, use the following command. Be sure to replace variables and configure options as necessary.

```azurecli-interactive
 az aks create -g $MyResourceGroup -n $MyManagedCluster \ 
  --enable-eraser \ 
  --eraser-allowlist "" \ 
  --eraser-vulnerability-scan true \ 
  --eraser-vulnerability-severity "high" 
```

To enable Eraser on an existing AKS cluster using manual mode, use the following command:

```azurecli-interactive
az aks update -g $MyResourceGroup -n $MyManagedCluster --enable-eraser 
  --enable-eraser \ 
  --eraser-allowlist "" \ 
  --eraser-vulnerability-scan true \ 
  --eraser-vulnerability-severity "high"  
```

Next, create an `ImageList` CRD with the appropriate image tags. For example, save the following as `my-image-list.yml`:

```yml
apiVersion: eraser.sh/v1alpha1 
kind: Imagelist 
metadata: 
  name: imagelist 
spec: 
  images: 
    - sha256:2834dc507516af02784808c5f48b7cbe38b8ed5d0f4837f16e78d00deb7e7767 
    - docker.io/library/nginx:latest 
    - redis/* # use "*" for all non-running images
```

and apply it to your cluster:

```azurecli-interactive
kubectl apply -f my-image-list.yml
```

Eraser will automatically remove the images on this list from cluster nodes.

### Automatic mode

#### Enable eraser on your cluster

To create a new AKS cluster using automatic mode:

```azurecli-interactive
az aks create -g MyResourceGroup -n MyManagedCluster \ 
  --enable-eraser \ 
  --eraser-interval "24h" \ 
  --eraser-allowlist "" \ 
  --eraser-vulnerability-scan true \ 
  --eraser-vulnerability-severity "high" 
```

To enable on an existing AKS cluster using automatic mode:

```azurecli-interactive
az aks create -g MyResourceGroup -n MyManagedCluster \ 
  --enable-eraser \ 
  --eraser-interval "24h" \ 
  --eraser-allowlist "" \ 
  --eraser-vulnerability-scan true \ 
  --eraser-vulnerability-severity "high" 
```

Based on your configuration, Eraser will automatically generate an `ImageList` containing unreferenced/vulnerable images at the set interval. Eraser will automatically remove these images from cluster nodes.

## Disable Eraser

To stop using Eraser, you can disable it via the `--disable-eraser` flag.

## Logging

The deletion logs are stored in the `eraser-kind-worker` pods. You can check these via `kubectl logs` or via the Container Insights pod log table if the [Azure Monitor add-on](,/monitor-aks.md) is enabled.